/*

Define some resources to be created via the lxd provider

*/

resource "lxd_container" "test1" {
  remote = "local"
  name = "test1"
  image = "images:ubuntu/22.04"
  ephemeral = false
  profiles = ["default", data.external.user.result.user]
  type = "virtual-machine"

  config = {
    "boot.autostart" = true
  }
}


// This profile will allow the home directory of the current user to be mapped
// inside a lxd container / vm. Which means things like ssh keys, and configuration
// files are shared. Allowing for easier testing / editing / etc.
resource "lxd_profile" "userprofile" {
  name        = data.external.user.result.user
  config      = {
    "raw.idmap"      = <<-EOT
       uid 1000 1000
       gid 1000 1000
    EOT
    "user.user-data" = <<-EOT
      #cloud-config
      users:
        - name: woutervb
          groups: sudo
          shell: /bin/bash
          sudo: ['ALL=(ALL) NOPASSWD:ALL']
      # ensure users shell is installed
      packages:
        - bash
      write_files:
        - path: "/etc/environment"
          content: |
            http_proxy="http://10.255.255.1:3128"
            https_proxy="http://10.255.255.1:3128"
            no_proxy="localhost,127.0.0.1,::1,pypi.ols.canonical.com,localhost,10.31.93.1,10.31.93.2,10.31.93.3,10.31.93.4,10.31.93.5,10.31.93.6,10.31.93.7,10.31.93.8,10.31.93.9,10.31.93.10,10.31.93.11,10.31.93.12,10.31.93.13,10.31.93.14,10.31.93.15,10.31.93.16,10.31.93.17,10.31.93.18,10.31.93.19,10.31.93.20,10.31.93.21,10.31.93.22,10.31.93.23,10.31.93.24,10.31.93.25,10.31.93.26,10.31.93.27,10.31.93.28,10.31.93.29,10.31.93.30,10.31.93.31,10.31.93.32,10.31.93.33,10.31.93.34,10.31.93.35,10.31.93.36,10.31.93.37,10.31.93.38,10.31.93.39,10.31.93.40,10.31.93.41,10.31.93.42,10.31.93.43,10.31.93.44,10.31.93.45,10.31.93.46,10.31.93.47,10.31.93.48,10.31.93.49,10.31.93.50,10.31.93.51,10.31.93.52,10.31.93.53,10.31.93.54,10.31.93.55,10.31.93.56,10.31.93.57,10.31.93.58,10.31.93.59,10.31.93.60,10.31.93.61,10.31.93.62,10.31.93.63,10.31.93.64,10.31.93.65,10.31.93.66,10.31.93.67,10.31.93.68,10.31.93.69,10.31.93.70,10.31.93.71,10.31.93.72,10.31.93.73,10.31.93.74,10.31.93.75,10.31.93.76,10.31.93.77,10.31.93.78,10.31.93.79,10.31.93.80,10.31.93.81,10.31.93.82,10.31.93.83,10.31.93.84,10.31.93.85,10.31.93.86,10.31.93.87,10.31.93.88,10.31.93.89,10.31.93.90,10.31.93.91,10.31.93.92,10.31.93.93,10.31.93.94,10.31.93.95,10.31.93.96,10.31.93.97,10.31.93.98,10.31.93.99,10.31.93.100,10.31.93.101,10.31.93.102,10.31.93.103,10.31.93.104,10.31.93.105,10.31.93.106,10.31.93.107,10.31.93.108,10.31.93.109,10.31.93.110,10.31.93.111,10.31.93.112,10.31.93.113,10.31.93.114,10.31.93.115,10.31.93.116,10.31.93.117,10.31.93.118,10.31.93.119,10.31.93.120,10.31.93.121,10.31.93.122,10.31.93.123,10.31.93.124,10.31.93.125,10.31.93.126,10.31.93.127,10.31.93.128,10.31.93.129,10.31.93.130,10.31.93.131,10.31.93.132,10.31.93.133,10.31.93.134,10.31.93.135,10.31.93.136,10.31.93.137,10.31.93.138,10.31.93.139,10.31.93.140,10.31.93.141,10.31.93.142,10.31.93.143,10.31.93.144,10.31.93.145,10.31.93.146,10.31.93.147,10.31.93.148,10.31.93.149,10.31.93.150,10.31.93.151,10.31.93.152,10.31.93.153,10.31.93.154,10.31.93.155,10.31.93.156,10.31.93.157,10.31.93.158,10.31.93.159,10.31.93.160,10.31.93.161,10.31.93.162,10.31.93.163,10.31.93.164,10.31.93.165,10.31.93.166,10.31.93.167,10.31.93.168,10.31.93.169,10.31.93.170,10.31.93.171,10.31.93.172,10.31.93.173,10.31.93.174,10.31.93.175,10.31.93.176,10.31.93.177,10.31.93.178,10.31.93.179,10.31.93.180,10.31.93.181,10.31.93.182,10.31.93.183,10.31.93.184,10.31.93.185,10.31.93.186,10.31.93.187,10.31.93.188,10.31.93.189,10.31.93.190,10.31.93.191,10.31.93.192,10.31.93.193,10.31.93.194,10.31.93.195,10.31.93.196,10.31.93.197,10.31.93.198,10.31.93.199,10.31.93.200,10.31.93.201,10.31.93.202,10.31.93.203,10.31.93.204,10.31.93.205,10.31.93.206,10.31.93.207,10.31.93.208,10.31.93.209,10.31.93.210,10.31.93.211,10.31.93.212,10.31.93.213,10.31.93.214,10.31.93.215,10.31.93.216,10.31.93.217,10.31.93.218,10.31.93.219,10.31.93.220,10.31.93.221,10.31.93.222,10.31.93.223,10.31.93.224,10.31.93.225,10.31.93.226,10.31.93.227,10.31.93.228,10.31.93.229,10.31.93.230,10.31.93.231,10.31.93.232,10.31.93.233,10.31.93.234,10.31.93.235,10.31.93.236,10.31.93.237,10.31.93.238,10.31.93.239,10.31.93.240,10.31.93.241,10.31.93.242,10.31.93.243,10.31.93.244,10.31.93.245,10.31.93.246,10.31.93.247,10.31.93.248,10.31.93.249,10.31.93.250,10.31.93.251,10.31.93.252,10.31.93.253,10.31.93.254,10.31.93.255"
          append: true
    EOT
  }

  device {
    name       = "home"
    properties = {
      "path"   = data.external.user.result.home
      "source" = data.external.user.result.home
    }
    type       = "disk"
  }
}

